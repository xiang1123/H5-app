name: Deploy H5 App

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: Display Versions
      run: |
        echo "=========================================="
        echo "环境信息"
        echo "=========================================="
        echo "Node: $(node -v)"
        echo "pnpm: $(pnpm -v)"
        echo "=========================================="
    
    - name: Install Dependencies
      run: |
        echo "安装依赖..."
        pnpm install --frozen-lockfile
        echo "✓ 依赖安装完成"
    
    - name: Build Project
      run: |
        echo "=========================================="
        echo "开始构建..."
        echo "=========================================="
        pnpm run build
        echo "✓ 构建完成"
      env:
        NODE_ENV: production
    
    - name: List Build Files
      run: |
        echo "=========================================="
        echo "构建产物"
        echo "=========================================="
        echo "文件列表："
        ls -lah dist/
        echo ""
        echo "目录结构："
        tree -L 2 dist/ || find dist/ -maxdepth 2 -print
        echo ""
        echo "总大小："
        du -sh dist/
        echo "=========================================="
    
    - name: Clean Old Files
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "清理旧文件..."
          if [ -d "${{ secrets.SERVER_PATH }}" ]; then
            sudo rm -rf ${{ secrets.SERVER_PATH }}/*
            echo "✓ 旧文件已清理"
          else
            echo "⚠️ 目录不存在，创建目录..."
            sudo mkdir -p ${{ secrets.SERVER_PATH }}
          fi
    
    - name: Deploy to Server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "dist/*"
        target: ${{ secrets.SERVER_PATH }}
        strip_components: 1
        overwrite: true
    
    - name: Verify and Restart
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "=========================================="
          echo "H5 App 部署验证"
          echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          
          # 检查部署目录
          if [ ! -d "${{ secrets.SERVER_PATH }}" ]; then
            echo "❌ 部署目录不存在！"
            exit 1
          fi
          
          echo "📁 部署目录内容："
          ls -lah ${{ secrets.SERVER_PATH }} | head -n 20
          
          # 检查关键文件
          echo ""
          echo "=========================================="
          echo "检查关键文件..."
          
          if [ -f "${{ secrets.SERVER_PATH }}/index.html" ]; then
            echo "✓ index.html 存在"
            FILE_SIZE=$(du -h "${{ secrets.SERVER_PATH }}/index.html" | cut -f1)
            echo "  大小: $FILE_SIZE"
            echo ""
            echo "  内容预览:"
            head -n 8 ${{ secrets.SERVER_PATH }}/index.html
          else
            echo "❌ index.html 不存在！"
            exit 1
          fi
          
          if [ -d "${{ secrets.SERVER_PATH }}/assets" ]; then
            echo ""
            echo "✓ assets 目录存在"
            echo "  文件数: $(find ${{ secrets.SERVER_PATH }}/assets -type f | wc -l)"
            echo "  总大小: $(du -sh ${{ secrets.SERVER_PATH }}/assets | cut -f1)"
          fi
          
          # 设置权限
          echo ""
          echo "=========================================="
          echo "🔒 设置文件权限..."
          sudo chown -R www-data:www-data ${{ secrets.SERVER_PATH }} 2>/dev/null || \
          sudo chown -R nginx:nginx ${{ secrets.SERVER_PATH }}
          sudo chmod -R 755 ${{ secrets.SERVER_PATH }}
          echo "✓ 权限设置完成"
          
          # 处理 Nginx
          echo ""
          echo "=========================================="
          echo "🔄 处理 Nginx..."
          
          # 测试配置
          if sudo nginx -t 2>&1 | grep -q "successful"; then
            echo "✓ Nginx 配置正确"
          else
            echo "⚠️ Nginx 配置可能有问题"
            sudo nginx -t
          fi
          
          # 重载 Nginx
          if pgrep nginx > /dev/null; then
            echo "Nginx 正在运行，重新加载配置..."
            sudo systemctl reload nginx 2>/dev/null || sudo nginx -s reload
            echo "✓ Nginx 配置已重新加载"
          else
            echo "Nginx 未运行，启动服务..."
            sudo systemctl start nginx 2>/dev/null || sudo /usr/sbin/nginx
            sleep 2
          fi
          
          # 验证 Nginx 状态
          if pgrep nginx > /dev/null; then
            echo "✅ Nginx 运行正常"
            echo ""
            echo "进程信息:"
            ps aux | grep nginx | grep -v grep | head -n 3
          else
            echo "❌ Nginx 启动失败"
            echo "查看错误日志:"
            sudo tail -n 20 /var/log/nginx/error.log 2>/dev/null || echo "无法读取日志"
            exit 1
          fi
          
          # 测试端口
          echo ""
          echo "端口监听:"
          sudo netstat -tlnp | grep :80 | head -n 2 || \
          sudo ss -tlnp | grep :80 | head -n 2
          
          echo ""
          echo "=========================================="
          echo "✅ H5 App 部署完成！"
          echo "=========================================="
          echo "🌐 访问地址："
          echo "  📱 http://h5.yyzzhhh.work.gd"
          echo "  📱 http://8.216.6.228 (如果是主域名)"
          echo "=========================================="
    
    - name: Test Website
      run: |
        echo "=========================================="
        echo "测试网站访问..."
        echo "=========================================="
        sleep 5
        
        # 测试 IP 访问
        echo "测试服务器 IP..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }} || echo "000")
        echo "HTTP 状态码: $HTTP_CODE"
        
        # 测试域名访问
        echo ""
        echo "测试域名..."
        DOMAIN_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://h5.yyzzhhh.work.gd || echo "000")
        echo "HTTP 状态码: $DOMAIN_CODE"
        
        if [ "$DOMAIN_CODE" = "200" ]; then
          echo "✅ 域名访问正常"
        else
          echo "⚠️ 域名访问异常，状态码: $DOMAIN_CODE"
          echo "可能原因："
          echo "  1. DNS 解析未生效（需要等待）"
          echo "  2. Nginx 配置问题"
          echo "  3. 防火墙阻止"
        fi
        echo "=========================================="
    
    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "📊 部署摘要"
        echo "=========================================="
        echo "项目: H5 App"
        echo "分支: ${{ github.ref_name }}"
        echo "提交: ${{ github.sha }}"
        echo "提交者: ${{ github.actor }}"
        echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        if [ ${{ job.status }} == 'success' ]; then
          echo "状态: ✅ 部署成功"
          echo ""
          echo "访问地址:"
          echo "  📱 http://h5.yyzzhhh.work.gd"
          echo ""
          echo "提示:"
          echo "  - 请使用手机或浏览器移动模式访问"
          echo "  - 首次访问可能需要清除缓存"
          echo "  - 如果域名无法访问，请等待 DNS 解析生效"
        else
          echo "状态: ❌ 部署失败"
          echo ""
          echo "请检查:"
          echo "  1. 构建是否成功"
          echo "  2. 服务器连接是否正常"
          echo "  3. Nginx 配置是否正确"
          echo "  4. 查看上面的错误日志"
        fi
        echo "=========================================="
